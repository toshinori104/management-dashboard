<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ¥­å‹™ä¸€å…ƒåŒ–ãƒ‡ãƒ¢ v3.3+ï¼ˆå›³é¢ã‚¿ãƒ–çµ±åˆãƒ»å·¥ç¨‹è‡ªå‹•é·ç§»ãƒ»æ¡ç•ªãƒ»ãƒã‚¹ã‚¿ãƒ¼ç·¨é›†ãƒ»PDFãƒ¢ãƒƒã‚¯ï¼‰</title>
  <style>
    :root {
      --bg: #f7fafd;
      --card: #ffffff;
      --line: #b9c3d0;
      --text: #0f172a;
      --muted: #64748b;
      --primary: #217be3;
      --pill: #eef2ff;
      --bad: #fee2e2;
      --soon: #fff7ed;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: "Yu Gothic", "Meiryo", system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); }
    header { position: sticky; top:0; z-index:10; background: var(--card); border-bottom: 1px solid var(--line); }
    .container { max-width: 1250px; margin: 0 auto; padding: 14px; }
    h1 { margin: 0 0 8px 0; font-size: 20px; }
    .controls { display:flex; flex-wrap: wrap; gap:8px; align-items: center; margin: 8px 0 12px; }
    .controls > * { font-size: 14px; }
    select, input[type="text"], input[type="date"], button { padding: 6px 10px; border:1px solid var(--line); background: #fff; border-radius: 8px; }
    button.primary { background: var(--primary); color: #fff; border-color: var(--primary); cursor:pointer; }
    button.ghost { background: #fff; border-color: var(--line); color: var(--text); cursor:pointer; }
    .tabs { display:flex; flex-wrap:wrap; gap:8px; margin: 8px 0; }
    .tab { padding: 8px 12px; border:1px solid var(--line); border-bottom-width:2px; border-radius: 10px; background:#fff; cursor:pointer; }
    .tab.active { border-color: var(--primary); color: var(--primary); font-weight: 700; }
    main { padding:16px; }
    .card { background: var(--card); border:1px solid var(--line); border-radius: 12px; overflow:hidden; }
    table { width:100%; border-collapse: collapse; font-size: 13px; min-width: 1280px; }
    th, td { border-bottom: 1px solid var(--line); padding: 8px 10px; text-align: left; }
    th { background:#f1f5f9; position: sticky; top: 0; z-index: 2; user-select: none; }
    tbody tr:hover { background: #f8fafc; cursor: pointer; }
    .muted { color: var(--muted); }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; background: var(--pill); }
    .status-å›³é¢ { background:#e0f2fe; color:#075985; }
    .status-è£½ä½œ { background:#e2e8f0; color:#0f172a; }
    .status-æ¤œæŸ» { background:#fef9c3; color:#854d0e; }
    .status-å‡ºè· { background:#dcfce7; color:#166534; }
    .status-ç€ { background:#ede9fe; color:#5b21b6; }
    .status-è«‹æ±‚ { background:#ffe4e6; color:#9f1239; }
    .kanban { display:grid; grid-template-columns: repeat(6, 1fr); gap:12px; }
    .col { background:#fff; border:1px solid var(--line); border-radius:12px; padding:10px; min-height: 240px; }
    .col h3 { margin:0 0 8px; font-size: 14px; }
    .card-k { background:#fff; border:1px solid var(--line); border-radius:10px; padding:8px; margin:8px 0; box-shadow: 0 1px 0 #e2e8f0; }
    .card-k .title { font-weight: 700; }
    .dropzone { min-height: 180px; }
    .col.over { outline: 2px dashed var(--primary); outline-offset: 4px; }
    .week { display:grid; grid-template-columns: 260px 1fr; gap:8px; border-bottom:1px dashed var(--line); padding: 8px 0; }
    .bar { height: 10px; border-radius: 999px; background:#dbeafe; }
    .right { text-align:right; }
    footer { padding: 4px 16px 16px; color: var(--muted); font-size: 12px; }
    dialog { border:none; border-radius: 12px; width: 820px; max-width: 95vw; }
    dialog::backdrop { background: rgba(0,0,0,0.3); }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 8px 12px; }
    .grid label { font-size: 12px; color: var(--muted); }
    .row { display:flex; gap:8px; align-items: center; }
    .flex { display:flex; gap:8px; align-items:center; }
    .spacer { flex: 1 1 auto; }
    .hidden { display:none !important; }
    .nowrap { white-space: nowrap; }
    .warnings { background:#fff; border:1px solid var(--line); border-radius:10px; padding:8px 12px; margin:8px; }
    .due-bad { background: var(--bad); }
    .due-soon { background: var(--soon); }
    .settings { margin-left: 8px; border:1px solid var(--line); border-radius:10px; padding:4px 8px; display:flex; align-items:center; gap:6px; }
    .filters { display:flex; flex-wrap:wrap; gap:8px; margin: 8px 0; }
    .role { margin-left: 8px; }
    .section-head { display:flex; align-items:center; gap:8px; padding:10px 14px; border-bottom:1px solid var(--line); background:#f8fafc; }
    .section-body { padding:10px 14px; }
    .subtle { font-size:12px; color:var(--muted); }
    .toast { position:fixed; bottom:16px; right:16px; background:#111; color:#fff; padding:10px 12px; border-radius:10px; opacity:0.92; }

    /* å›ºå®šåˆ—ï¼ˆå·¥ç•ªï¼‰ */
    #jobsTable th:first-child, #jobsTable td:first-child {
      position: sticky;
      left: 0;
      background: #fff;
      z-index: 3;
    }
    #jobsTable th:first-child { box-shadow: 2px 0 5px -2px rgba(0,0,0,0.1); }

    /* Masterãƒ“ãƒ¥ãƒ¼ã®è¦‹åˆ‡ã‚Œï¼†é‡ãªã‚Šå¯¾ç­– */
    #view-masters .section-body { overflow-x: auto; }

    /* 4ã¤ã®ãƒã‚¹ã‚¿ãƒ¼æ ãŒç‹­ã„æ™‚ã«åã¾ã‚‹ã‚ˆã†æœ€å°å¹…ã‚’ç¢ºä¿ */
    #view-masters .section-body .row > div { min-width: 340px; padding-right: 6px; }

    /* å„è¡Œï¼ˆãƒã‚§ãƒƒã‚¯ãƒ»ã‚³ãƒ¼ãƒ‰ãƒ»åç§°ãƒ»ãƒœã‚¿ãƒ³ï¼‰ã‚’æŠ˜è¿”ã—å¯ã« */
    #view-masters .section-body .row { flex-wrap: wrap; }

    /* ã‚³ãƒ¼ãƒ‰/åç§°ã®å¹…ã‚’å®‰å®šåŒ– */
    #view-masters .m-code { flex: 0 0 90px !important; max-width: 120px; }
    #view-masters .m-name { flex: 1 1 280px !important; min-width: 220px; }

    /* ãƒœã‚¿ãƒ³ãŒæ½°ã‚Œãªã„ã‚ˆã†å›ºå®š */
    #view-masters .section-body .row button { flex: 0 0 auto; white-space: nowrap; }

    /* ã‚½ãƒ¼ãƒˆçŸ¢å° */
    .sort-indicator { margin-left:4px; font-size:10px; }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>æ¥­å‹™ä¸€å…ƒåŒ–ãƒ‡ãƒ¢ v3.3+ï¼ˆå›³é¢ã‚¿ãƒ–çµ±åˆãƒ»å·¥ç¨‹è‡ªå‹•é·ç§»ãƒ»æ¡ç•ªãƒ»ãƒã‚¹ã‚¿ãƒ¼ç·¨é›†ãƒ»PDFãƒ¢ãƒƒã‚¯ï¼‰</h1>
      <div class="controls">
        <button class="primary" id="btnAdd">ï¼‹ æ–°è¦è¿½åŠ </button>
        <button class="ghost" id="btnSave">ä¿å­˜</button>
        <button class="ghost" id="btnExportCsv">CSVå‡ºåŠ›</button>
        <button class="ghost" id="btnExportJson">JSONå‡ºåŠ›</button>
        <button class="ghost" id="btnExportInvoice">è«‹æ±‚CSVå‡ºåŠ›</button>
        <label class="ghost" style="padding:0 8px; border: none;">
          JSONå–è¾¼ <input id="jsonFile" type="file" accept="application/json" />
        </label>
        <label class="ghost" style="padding:0 8px; border: none;">
          CSVå–è¾¼ï¼ˆæ¡ˆä»¶ï¼‰ <input id="jobsCsv" type="file" accept=".csv" />
        </label>
        <label class="ghost" style="padding:0 8px; border: none;">
          ãƒ¬ãƒ¼ã‚¶ãƒ¼Zipå–è¾¼ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰ <input id="laserZip" type="file" accept=".zip" />
        </label>
        <button class="ghost" id="btnDownloadCsvTemplate">CSVãƒ†ãƒ³ãƒ—ãƒ¬</button>
        <span class="spacer"></span>
        <div class="settings">
          <label>ç´å“æ›¸ç•ªå·ï¼š</label>
          <select id="invoiceMode">
            <option value="manual">æ‰‹å…¥åŠ›</option>
            <option value="auto-seq">é€£ç•ª(YYMM-####)</option>
            <option value="by-customer-seq">å®¢å…ˆåˆ¥(DK-YYMM-####)</option>
          </select>
          <input id="invoiceSeqStart" type="text" placeholder="é–‹å§‹ç•ªå·ï¼ˆä¾‹: 0001ï¼‰" style="width:130px;">
          <label class="ghost" style="padding:0 8px; border:none;">ä¼‘æ—¥CSV <input id="holidayCsv" type="file" accept=".csv" /></label>
          <label class="role">
            ãƒ­ãƒ¼ãƒ«ï¼š
            <select id="roleSelect">
              <option value="admin">ç¤¾é•·</option>
              <option value="officeA">äº‹å‹™A</option>
              <option value="officeB">äº‹å‹™B</option>
              <option value="factory">è£½é€ </option>
            </select>
          </label>
        </div>
      </div>

      <div class="filters">
        <input id="filterQuery" type="text" placeholder="ãƒ•ãƒªãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆå·¥ç•ª/å·¥äº‹å/å“åï¼‰" style="min-width:260px;">
        <select id="filterCustomer"><option value="">å®¢å…ˆï¼ˆã™ã¹ã¦ï¼‰</option></select>
        <select id="filterFactory"><option value="">è£½ä½œå·¥å ´ï¼ˆã™ã¹ã¦ï¼‰</option></select>
        <select id="filterStatus"><option value="">çŠ¶æ³ï¼ˆã™ã¹ã¦ï¼‰</option></select>
        <button class="ghost" id="btnClearFilters">ãƒ•ã‚£ãƒ«ã‚¿è§£é™¤</button>
      </div>

      <div class="tabs">
        <div class="tab active" data-tab="list">ä¸€è¦§</div>
        <div class="tab" data-tab="kanban">ã‚«ãƒ³ãƒãƒ³</div>
        <div class="tab" data-tab="weekly">é€±æ¬¡</div>
        <div class="tab" data-tab="drawings">å›³é¢</div>
        <div class="tab" data-tab="masters">ãƒã‚¹ã‚¿ãƒ¼</div>
        <div class="tab" data-tab="logs">ãƒ­ã‚°</div>
        <div class="tab" data-tab="docs">PDF</div>
      </div>
    </div>
  </header>

  <main class="container">
    <div id="warnings" class="warnings hidden"></div>

    <section id="view-list" class="card">
      <div style="overflow:auto; max-height: 58vh;">
        <table id="jobsTable">
          <thead>
            <tr>
              <th data-key="jobNo">å·¥ç•ª <span class="sort-indicator"></span></th>
              <th data-key="customer">å®¢å…ˆ <span class="sort-indicator"></span></th>
              <th data-key="projectName">å·¥äº‹å <span class="sort-indicator"></span></th>
              <th data-key="itemName">å“å <span class="sort-indicator"></span></th>
              <th data-key="qty" class="right">å°æ•° <span class="sort-indicator"></span></th>
              <th data-key="factory">è£½ä½œå·¥å ´ <span class="sort-indicator"></span></th>
              <th data-key="dueDate">ç´æœŸ <span class="sort-indicator"></span></th>
              <th data-key="status">çŠ¶æ³ <span class="sort-indicator"></span></th>
              <th data-key="inspection">æ¤œæŸ» <span class="sort-indicator"></span></th>
              <th data-key="shipDate">å‡ºè·æ—¥ <span class="sort-indicator"></span></th>
              <th data-key="arriveDate">ç€æ—¥ <span class="sort-indicator"></span></th>
              <th data-key="shipMethod">å‡ºè·æ‰‹æ®µ <span class="sort-indicator"></span></th>
              <th data-key="deliveryTo">ç´å“å…ˆ <span class="sort-indicator"></span></th>
              <th data-key="invoiceOk">è«‹æ±‚å¯ <span class="sort-indicator"></span></th>
              <th data-key="invoiceNo">ç´å“æ›¸ç•ªå· <span class="sort-indicator"></span></th>
              <th data-key="notes">å‚™è€ƒ <span class="sort-indicator"></span></th>
              <th data-key="remaining" class="right">æ®‹æ—¥</th>
              <th data-key="workdays" class="right">ç¨¼åƒæ—¥</th>
              <th data-key="autoFlow">è‡ªå‹•é·ç§»</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="view-kanban" class="hidden">
      <div class="kanban" id="kanban"></div>
    </section>

    <section id="view-weekly" class="hidden card" style="padding:12px;">
      <div id="weekly"></div>
    </section>

    <!-- å›³é¢ãƒ“ãƒ¥ãƒ¼ -->
    <section id="view-drawings" class="hidden card">
      <div class="section-head">
        <strong>å›³é¢ç®¡ç†ï¼ˆç«¯æœ«ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ãƒ¢ãƒƒã‚¯ï¼‰</strong>
        <span class="spacer"></span>
        <label>ãƒ•ã‚¡ã‚¤ãƒ« <input id="dwgFiles" type="file" multiple accept=".pdf,.png,.jpg,.jpeg,.gif"></label>
        <select id="dwgJob"><option value="">å·¥ç•ªé¸æŠ</option></select>
        <input id="dwgProject" type="text" placeholder="å·¥äº‹å">
        <input id="dwgDeliveryTo" type="text" placeholder="ç´å“å…ˆ">
        <input id="dwgItem" type="text" placeholder="å“å">
        <input id="dwgNumber" type="text" placeholder="å›³ç•ª">
        <input id="dwgDate" type="date" placeholder="ä½œå›³æ—¥ä»˜" value="">
        <input id="dwgApprove" type="text" placeholder="æ‰¿èª">
        <input id="dwgCheck" type="text" placeholder="ç…§æŸ»">
        <input id="dwgDesign" type="text" placeholder="è¨­è¨ˆ">
        <input id="dwgAuthor" type="text" placeholder="ä½œæˆè€…">
        <button id="btnDwgUpload" class="primary">ç™»éŒ²</button>
      </div>
      <div class="section-body">
        <div class="controls">
          <input id="qDwgJob"  type="text" placeholder="å·¥ç•ªæ¤œç´¢">
          <input id="qDwgCust" type="text" placeholder="å®¢å…ˆæ¤œç´¢">
          <input id="qDwgProject" type="text" placeholder="å·¥äº‹åæ¤œç´¢">
          <input id="qDwgDeliveryTo" type="text" placeholder="ç´å“å…ˆæ¤œç´¢">
          <input id="qDwgItem" type="text" placeholder="å“åæ¤œç´¢">
          <input id="qDwgNumber" type="text" placeholder="å›³ç•ªæ¤œç´¢">
          <input id="qDwgApprove" type="text" placeholder="æ‰¿èªæ¤œç´¢">
          <input id="qDwgCheck" type="text" placeholder="ç…§æŸ»æ¤œç´¢">
          <input id="qDwgDesign" type="text" placeholder="è¨­è¨ˆæ¤œç´¢">
          <input id="qDwgAuthor" type="text" placeholder="ä½œæˆè€…æ¤œç´¢">
          <input id="qDwgFile" type="text" placeholder="ãƒ•ã‚¡ã‚¤ãƒ«åæ¤œç´¢">
          <button id="btnDwgClear" class="ghost">ã‚¯ãƒªã‚¢</button>
        </div>
        <table id="dwgTable">
          <thead>
            <tr>
              <th>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</th>
              <th>ç´å“å…ˆ</th>
              <th>å·¥äº‹å</th>
              <th>å·¥ç•ª</th>
              <th>å›³ç•ª</th>
              <th>ä½œå›³æ—¥ä»˜</th>
              <th>æ‰¿èª</th>
              <th>ç…§æŸ»</th>
              <th>è¨­è¨ˆ</th>
              <th>ä½œæˆè€…</th>
              <th>ãƒ•ã‚¡ã‚¤ãƒ«å</th>
              <th>ç™»éŒ²è€…/æ—¥æ™‚</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="view-masters" class="hidden card">
      <div class="section-head">
        <strong>ãƒã‚¹ã‚¿ãƒ¼ç·¨é›†</strong><span class="subtle">ï¼ˆCSVå…¥å‡ºåŠ›å¯ï¼‰</span>
        <span class="spacer"></span>
        <button id="btnExportMasters" class="ghost">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <label class="ghost" style="padding:0 8px; border:none;">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ <input id="mastersCsv" type="file" accept=".csv" /></label>
      </div>
      <div class="section-body">
        <div class="row">
          <div style="flex:1; min-width:180px;">
            <label>å®¢å…ˆ</label>
            <div id="master-customers"></div>
          </div>
          <div style="flex:1; min-width:180px;">
            <label>è£½ä½œå·¥å ´</label>
            <div id="master-factories"></div>
          </div>
          <div style="flex:1; min-width:180px;">
            <label>å‡ºè·æ‰‹æ®µ</label>
            <div id="master-ship"></div>
          </div>
          <div style="flex:1; min-width:180px;">
            <label>å·¥ç¨‹</label>
            <div id="master-statuses"></div>
          </div>
        </div>
        <div style="margin-top:16px; border-top:1px solid var(--line); padding-top:8px;">
          <strong>æ¤œæŸ»ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆCSVã§ç®¡ç†ï¼‰</strong>
          <div style="margin:6px 0; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
            <label class="ghost" style="padding:0 8px; border:none;">å–ã‚Šè¾¼ã¿ <input id="inspectionTemplatesCsv" type="file" accept=".csv" /></label>
            <button class="ghost" id="btnExportInspectionTemplates">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          </div>
          <div id="inspection-templates-list" style="max-width:100%; overflow:auto;">
            <!-- ãƒªã‚¹ãƒˆè¡¨ç¤º -->
          </div>
          <div class="subtle" style="margin-top:8px;">CSVã¯ã€Œãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå, é …ç›®1;é …ç›®2;é …ç›®3ã€ã®å½¢å¼ã€‚è¤‡æ•°é …ç›®ã¯ã‚»ãƒŸã‚³ãƒ­ãƒ³åŒºåˆ‡ã‚Šã€‚</div>
        </div>
        <div class="subtle" style="margin-top:8px;">è¡Œã‚’è¿½åŠ /å‰Šé™¤ã€ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³æ›¿ãˆã€‚ç„¡åŠ¹åŒ–ã¯è¡Œé ­ã®ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ã¾ã™ã€‚</div>
      </div>
    </section>

    <section id="view-logs" class="hidden card">
      <div class="section-head"><strong>æ“ä½œãƒ­ã‚°</strong></div>
      <div class="section-body">
        <div id="logs"></div>
      </div>
    </section>

    <section id="view-docs" class="hidden card">
      <div class="section-head"><strong>PDFãƒ¢ãƒƒã‚¯</strong><span class="subtle">ï¼ˆè«‹æ±‚/ç´å“ã²ãªå½¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰</span>
        <span class="spacer"></span>
        <button id="btnGenPdf" class="ghost">PDFç”Ÿæˆï¼ˆãƒ¢ãƒƒã‚¯ï¼‰</button>
      </div>
      <div class="section-body">
        <iframe id="pdfFrame" style="width:100%; height:60vh; border:1px solid var(--line); background:#fff;"></iframe>
      </div>
    </section>
  </main>

  <footer class="container">
    ãƒ­ãƒ¼ãƒ«åˆ‡æ›¿ãƒ»å·¥ç¨‹è‡ªå‹•é·ç§»ãƒ»æ¡ç•ªãƒ»ãƒã‚¹ã‚¿ãƒ¼ç·¨é›†ãƒ»æ¤œæŸ»ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ»ãƒ¬ãƒ¼ã‚¶ãƒ¼Zipãƒ¢ãƒƒã‚¯ãƒ»PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»å›³é¢ç®¡ç†ã‚’ä½“é¨“ã§ãã¾ã™ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰ã€‚  
    ã€Œè‡ªå‹•é·ç§»ã€ã¯çŠ¶æ…‹/æ—¥ä»˜/æ¤œæŸ»/å‚™è€ƒãƒ•ãƒ©ã‚°ã«å¾“ã£ã¦å†…éƒ¨çš„ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒåˆ‡ã‚Šæ›¿ã‚ã‚‹ä»•çµ„ã¿ã®ON/OFFè¡¨ç¤ºã§ã™ã€‚
  </footer>

  <dialog id="editDialog">
    <form id="editForm">
      <div style="padding: 10px 14px 0;" class="row">
        <h3 id="dlgTitle" style="margin:0;">ç·¨é›†</h3>
        <span class="spacer"></span>
        <button type="button" id="btnDlgCancel" class="ghost">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button type="submit" id="btnDlgSave" class="primary">ä¿å­˜</button>
      </div>
      <div style="padding: 10px 14px 16px;">
        <div class="grid">
          <div>
            <label>å·¥ç•ª</label>
            <input name="jobNo" type="text" style="width:100%" required />
          </div>
          <div>
            <label>å®¢å…ˆ</label>
            <select name="customer" style="width:100%"></select>
          </div>
          <div>
            <label>å·¥äº‹å</label>
            <input name="projectName" type="text" style="width:100%" />
          </div>
          <div>
            <label>å“å</label>
            <input name="itemName" type="text" style="width:100%" />
          </div>
          <div>
            <label>å°æ•°</label>
            <input name="qty" type="number" min="1" step="1" value="1" style="width:100%" />
          </div>
          <div>
            <label>è£½ä½œå·¥å ´</label>
            <select name="factory" style="width:100%"></select>
          </div>
          <div>
            <label>ç´æœŸ</label>
            <input name="dueDate" type="date" style="width:100%" />
          </div>
          <div>
            <label>çŠ¶æ³</label>
            <select name="status" style="width:100%"></select>
          </div>
          <div>
            <label>æ¤œæŸ»</label>
            <select name="inspection" style="width:100%"></select>
          </div>
          <div>
            <label>å‡ºè·æ—¥</label>
            <input name="shipDate" type="date" style="width:100%" />
          </div>
          <div>
            <label>ç€æ—¥</label>
            <input name="arriveDate" type="date" style="width:100%" />
          </div>
          <div>
            <label>å‡ºè·æ‰‹æ®µ</label>
            <select name="shipMethod" style="width:100%"></select>
          </div>
          <div>
            <label>ç´å“å…ˆ</label>
            <input name="deliveryTo" type="text" style="width:100%" />
          </div>
          <div>
            <label>è«‹æ±‚å¯</label>
            <select name="invoiceOk" style="width:100%">
              <option value="">â€•</option>
              <option value="å¯">å¯</option>
              <option value="ä¸å¯">ä¸å¯</option>
            </select>
          </div>
          <div>
            <label>ç´å“æ›¸ç•ªå·</label>
            <input name="invoiceNo" type="text" style="width:100%" />
          </div>
          <div>
            <label>è‡ªå‹•é·ç§»</label>
            <select name="autoFlow" style="width:100%">
              <option value="on">ON</option>
              <option value="off">OFF</option>
            </select>
          </div>
          <div style="grid-column: 1 / -1;">
            <label>å‚™è€ƒ</label>
            <input name="notes" type="text" style="width:100%" />
          </div>
        </div>
      </div>
    </form>
  </dialog>

  <div id="toast" class="toast hidden"></div>

  <script>
    // ---- Storage keys
    const STORAGE_KEY  = "tm_unified_jobs_v3_3";
    const SETTINGS_KEY = "tm_unified_settings_v3_3";
    const HOLIDAYS_KEY = "tm_unified_holidays_v3_3";
    const MASTERS_KEY  = "tm_unified_masters_v3_3";
    const LOGS_KEY     = "tm_unified_logs_v3_3";
    const DWG_KEY      = "tm_unified_drawings_v3_3";
    const INSPECTION_TEMPLATES_KEY = "tm_unified_inspection_templates_v3_3";

    // ---- Persisted data
    let jobs      = loadJobs();
    let settings  = loadSettings() || { invoiceMode:"by-customer-seq", invoiceSeqStart:"0001", invoiceSeqByCustomer:{}, autoFlowDefault:"on", role:"admin" };
    let holidays  = loadHolidays();
    let logs      = loadLogs();
    let dwgs      = loadDwgs();
    let inspectionTemplates = loadInspectionTemplates() || [];

    // ---- Masters (editable)
    let masters = loadMasters() || {
      customers: [
        {code:"DK", name:"å¤§å”", active:true},
        {code:"DT", name:"DT", active:true},
        {code:"NG", name:"ä¸­å·", active:true},
        {code:"OT", name:"ãã®ä»–", active:true},
      ],
      factories: [
        {code:"H1", name:"æœ¬ç¤¾å·¥å ´", active:true},
        {code:"H2", name:"ç¬¬2å·¥å ´", active:true},
        {code:"PA", name:"å”åŠ›å·¥å ´A", active:true},
      ],
      shipmentMethods: [
        {code:"T2", name:"è‡ªç¤¾2t", active:true},
        {code:"T4", name:"è‡ªç¤¾4t", active:true},
        {code:"10U", name:"10tãƒ¦ãƒ‹ãƒƒã‚¯", active:true},
        {code:"4U", name:"4tãƒ¦ãƒ‹ãƒƒã‚¯", active:true},
        {code:"10", name:"10t", active:true},
        {code:"TR", name:"ãƒˆãƒ¬ãƒ¼ãƒ©ãƒ¼", active:true},
        {code:"YO", name:"åº¸è»Š", active:true},
        {code:"DL", name:"å®…é…", active:true},
        {code:"PU", name:"å¼•å–", active:true},
      ],
      statuses: [
        {code:"D", name:"å›³é¢", active:true},
        {code:"M", name:"è£½ä½œ", active:true},
        {code:"I", name:"æ¤œæŸ»", active:true},
        {code:"S", name:"å‡ºè·", active:true},
        {code:"A", name:"ç€", active:true},
        {code:"B", name:"è«‹æ±‚", active:true},
      ],
      inspections: [
        {code:"N", name:"æœª", active:true},
        {code:"O", name:"OK", active:true},
        {code:"H", name:"ä¿ç•™", active:true},
      ]
    };

    // ---- Sort state
    let sortState = { key: null, dir: 1 }; // 1=asc, -1=desc

    // ---- Constants
    const INVOICE_AUTO_ON_ARRIVE = true;
    const DUE_SOON_DAYS = 3;

    // ---- Storage helpers
    function saveJobs(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(jobs)); }
    function loadJobs(){ const s = localStorage.getItem(STORAGE_KEY); return s ? JSON.parse(s) : seed(); }
    function saveSettings(){ localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings)); }
    function loadSettings(){ const s=localStorage.getItem(SETTINGS_KEY); return s?JSON.parse(s):null; }
    function saveHolidays(){ localStorage.setItem(HOLIDAYS_KEY, JSON.stringify(Array.from(holidays))); }
    function loadHolidays(){ const s=localStorage.getItem(HOLIDAYS_KEY); return s?new Set(JSON.parse(s)):new Set(); }
    function saveMasters(){ localStorage.setItem(MASTERS_KEY, JSON.stringify(masters)); }
    function loadMasters(){ const s=localStorage.getItem(MASTERS_KEY); return s?JSON.parse(s):null; }
    function saveLogs(){ localStorage.setItem(LOGS_KEY, JSON.stringify(logs)); }
    function loadLogs(){ const s=localStorage.getItem(LOGS_KEY); return s?JSON.parse(s):[]; }
    function saveDwgs(){ localStorage.setItem(DWG_KEY, JSON.stringify(dwgs)); }
    function loadDwgs(){ const s = localStorage.getItem(DWG_KEY); return s ? JSON.parse(s) : []; }
    function saveInspectionTemplates(){ localStorage.setItem(INSPECTION_TEMPLATES_KEY, JSON.stringify(inspectionTemplates)); }
    function loadInspectionTemplates(){ const s = localStorage.getItem(INSPECTION_TEMPLATES_KEY); return s?JSON.parse(s):null; }

    // ---- Utils
    function uid(){ return Math.random().toString(36).slice(2,10); }
    function todayStr(){ const d=new Date(); return d.toISOString().slice(0,10); }
    function fmtDate(s){ return s || ""; }
    function toast(msg){ const t=document.getElementById("toast"); t.textContent=msg; t.classList.remove("hidden"); setTimeout(()=> t.classList.add("hidden"), 1800); }
    function fileToDataUrl(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }

    // ---- Seed
    function seed(){
      const today = new Date();
      const f = (d)=> new Date(today.getFullYear(), today.getMonth(), today.getDate()+d).toISOString().slice(0,10);
      return [
        { id: uid(), jobNo:"7D1-1", customer:"å¤§å”", customerCode:"DK", projectName:"Aç‰©æµå€‰åº«", itemName:"æ¢å‹æ ", qty:5, factory:"æœ¬ç¤¾å·¥å ´", dueDate:f(2), status:"å›³é¢", inspection:"æœª", shipDate:"", arriveDate:"", shipMethod:"è‡ªç¤¾2t", deliveryTo:"Aç‰©æµå€‰åº«", invoiceOk:"", invoiceNo:"", notes:"", autoFlow:"on" },
        { id: uid(), jobNo:"7D2-3", customer:"DT", customerCode:"DT", projectName:"Bå†é–‹ç™º", itemName:"æŸ±å‹æ ", qty:2, factory:"ç¬¬2å·¥å ´", dueDate:f(1), status:"è£½ä½œ", inspection:"æœª", shipDate:"", arriveDate:"", shipMethod:"å®…é…", deliveryTo:"Bç¾å ´", invoiceOk:"ä¸å¯", invoiceNo:"", notes:"", autoFlow:"on" },
        { id: uid(), jobNo:"7D3-2", customer:"ä¸­å·", customerCode:"NG", projectName:"Cãƒ—ãƒ©ãƒ³ãƒˆ", itemName:"ã‚¹ãƒ©ãƒ–", qty:10, factory:"å”åŠ›å·¥å ´A", dueDate:f(-1), status:"æ¤œæŸ»", inspection:"OK", shipDate:f(0), arriveDate:"", shipMethod:"è‡ªç¤¾4t", deliveryTo:"Cç¾å ´", invoiceOk:"", invoiceNo:"", notes:"", autoFlow:"on" },
      ];
    }

    // ---- Filters & options
    function masterNames(list){ return list.filter(x=>x.active).map(x=>x.name); }
    function setOptions(sel, arr){ sel.innerHTML = arr.map(v=>`<option value="${v}">${v}</option>`).join(""); }
    function initFilters(){
      setOptions(document.getElementById("filterCustomer"), [""].concat(masterNames(masters.customers)));
      setOptions(document.getElementById("filterFactory"), [""].concat(masterNames(masters.factories)));
      setOptions(document.getElementById("filterStatus"), [""].concat(masterNames(masters.statuses)));
      ["filterCustomer","filterFactory","filterStatus","filterQuery"].forEach(id=>{
        const el=document.getElementById(id); if (el) el.addEventListener("input", renderAll);
      });

      document.getElementById("invoiceMode").value = settings.invoiceMode;
      document.getElementById("invoiceSeqStart").value = settings.invoiceSeqStart;
      document.getElementById("roleSelect").value = settings.role;

      document.getElementById("invoiceMode").addEventListener("change", (e)=>{ settings.invoiceMode=e.target.value; saveSettings(); });
      document.getElementById("invoiceSeqStart").addEventListener("change", (e)=>{ settings.invoiceSeqStart=e.target.value; saveSettings(); });
      document.getElementById("roleSelect").addEventListener("change", (e)=>{ settings.role=e.target.value; saveSettings(); renderAll(); });

      document.getElementById("holidayCsv").addEventListener("change", onHolidayCsv);
      document.getElementById("jobsCsv").addEventListener("change", onJobsCsv);
      document.getElementById("mastersCsv").addEventListener("change", onMastersCsv);
      document.getElementById("inspectionTemplatesCsv").addEventListener("change", onInspectionTemplatesCsv);
      document.getElementById("btnDownloadCsvTemplate").addEventListener("click", downloadCsvTemplate);
      document.getElementById("btnExportMasters").addEventListener("click", exportMastersCsv);
      document.getElementById("btnExportInspectionTemplates").addEventListener("click", exportInspectionTemplatesCsv);
      document.getElementById("btnExportCsv").addEventListener("click", exportCsv);
      document.getElementById("btnExportJson").addEventListener("click", exportJson);
      document.getElementById("btnExportInvoice").addEventListener("click", exportInvoiceCsv);
      document.getElementById("btnClearFilters").addEventListener("click", ()=>{
        ["filterQuery","filterCustomer","filterFactory","filterStatus"].forEach(id=>{ const el=document.getElementById(id); if (el) el.value=""; });
        renderAll();
      });
      document.getElementById("btnGenPdf").addEventListener("click", ()=>{
        const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>PDF Mock</title></head>
        <body style="font-family:Meiryo, sans-serif; padding:24px;">
          <h2>è«‹æ±‚æ›¸ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰</h2>
          <p>å®›å…ˆï¼šã€‡ã€‡å¾¡ä¸­</p>
          <table border="1" cellspacing="0" cellpadding="6">
            <tr><th>å·¥ç•ª</th><th>å“å</th><th>å°æ•°</th><th>ç´å“æ›¸ç•ªå·</th></tr>
            ${jobs.slice(0,5).map(j=>`<tr><td>${j.jobNo}</td><td>${j.itemName}</td><td>${j.qty}</td><td>${j.invoiceNo||"-"}</td></tr>`).join("")}
          </table>
          <p style="margin-top:24px;">â€»æœ¬ç•ªã¯mPDF/wkhtmltopdfã§ã‚µãƒ¼ãƒç”Ÿæˆã—ã¾ã™ã€‚</p>
        </body></html>`;
        const frame=document.getElementById("pdfFrame");
        const blob=new Blob([html],{type:"text/html"}); frame.src=URL.createObjectURL(blob);
      });

      // --- å›³é¢ æ¤œç´¢ã‚¤ãƒ™ãƒ³ãƒˆ
      ["qDwgJob","qDwgCust","qDwgProject","qDwgDeliveryTo","qDwgItem","qDwgNumber","qDwgApprove","qDwgCheck","qDwgDesign","qDwgAuthor","qDwgFile"].forEach(id=>{
        const el=document.getElementById(id); if (el) el.addEventListener("input", renderDwgs);
      });
      document.getElementById("btnDwgClear")?.addEventListener("click", ()=>{
        ["qDwgJob","qDwgCust","qDwgProject","qDwgDeliveryTo","qDwgItem","qDwgNumber","qDwgApprove","qDwgCheck","qDwgDesign","qDwgAuthor","qDwgFile"].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=""; });
        renderDwgs();
      });

      // --- å›³é¢ ç™»éŒ²
      document.getElementById("btnDwgUpload")?.addEventListener("click", async ()=>{
        const files = document.getElementById("dwgFiles").files;
        const job   = document.getElementById("dwgJob").value;
        const project = (document.getElementById("dwgProject").value||"").trim();
        const deliveryTo = (document.getElementById("dwgDeliveryTo").value||"").trim();
        const item  = (document.getElementById("dwgItem").value||"").trim();
        const number = (document.getElementById("dwgNumber").value||"").trim();
        const date = (document.getElementById("dwgDate").value||"").trim() || todayStr();
        const approve = (document.getElementById("dwgApprove").value||"").trim();
        const check = (document.getElementById("dwgCheck").value||"").trim();
        const design = (document.getElementById("dwgDesign").value||"").trim();
        const author = (document.getElementById("dwgAuthor").value||"").trim();
        if(!files || !files.length) return alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");
        if(!job) return alert("å·¥ç•ªã‚’é¸æŠã—ã¦ãã ã•ã„");

        const jobRow = jobs.find(x=>x.jobNo===job);
        for(const f of files){
          const url = await fileToDataUrl(f);
          dwgs.push({
            id: uid(),
            jobNo: job,
            customer: jobRow?.customer || "",
            projectName: project || jobRow?.projectName || "",
            deliveryTo: deliveryTo || jobRow?.deliveryTo || "",
            itemName: item || jobRow?.itemName || "",
            drawingNumber: number || "",
            drawingDate: date,
            approval: approve,
            check: check,
            design: design,
            author: author,
            fileName: f.name,
            mime: f.type || "application/octet-stream",
            dataUrl: url,
            uploadedBy: settings.role || "demo",
            uploadedAt: new Date().toISOString()
          });
        }
        saveDwgs();
        renderDwgs();
        alert("ç™»éŒ²ã—ã¾ã—ãŸï¼ˆç«¯æœ«ãƒ­ãƒ¼ã‚«ãƒ«ï¼‰");
        document.getElementById("dwgFiles").value="";
      });

      // --- JSONå–è¾¼ï¼ˆä»»æ„ï¼‰ for jobs
      document.getElementById("jsonFile")?.addEventListener("change", (e)=>{
        const f=e.target.files[0]; if(!f) return;
        const fr=new FileReader();
        fr.onload=()=>{
          try{
            const arr = JSON.parse(fr.result);
            if(!Array.isArray(arr)) throw new Error("é…åˆ—ã®JSONãŒå¿…è¦ã§ã™");
            jobs = arr;
            saveJobs();
            renderAll();
            alert("JSONã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸ");
          }catch(err){ alert("JSONå–è¾¼ã‚¨ãƒ©ãƒ¼: "+err.message); }
        };
        fr.readAsText(f);
        e.target.value="";
      });
    }

    function currentFilters(){
      return {
        customer: (document.getElementById("filterCustomer").value||""),
        factory: (document.getElementById("filterFactory").value||""),
        status: (document.getElementById("filterStatus").value||""),
        q: (document.getElementById("filterQuery").value||"").toLowerCase()
      };
    }

    function applyFilters(list){
      const f = currentFilters();
      return list.filter(r=>{
        if (f.customer && r.customer !== f.customer) return false;
        if (f.factory && r.factory !== f.factory) return false;
        if (f.status && r.status !== f.status) return false;
        if (f.q){
          const hay = [r.jobNo, r.projectName, r.itemName].join(" ").toLowerCase();
          if (!hay.includes(f.q)) return false;
        }
        return true;
      });
    }

    // ---- Sorting helper
    function sortJobs(list){
      if(!sortState.key) return list;
      const key = sortState.key;
      return [...list].sort((a,b)=>{
        let va = a[key] || "";
        let vb = b[key] || "";
        // æ—¥ä»˜æ¯”è¼ƒ
        if(key === "dueDate" || key==="shipDate" || key==="arriveDate"){
          va = va || "";
          vb = vb || "";
        }
        if(typeof va === "string") va = va.toLowerCase();
        if(typeof vb === "string") vb = vb.toLowerCase();
        if(va < vb) return -1 * sortState.dir;
        if(va > vb) return 1 * sortState.dir;
        return 0;
      });
    }

    function updateSortIndicators(){
      document.querySelectorAll("#jobsTable th").forEach(th=>{
        const key=th.dataset.key;
        const span=th.querySelector(".sort-indicator");
        if(!span) return;
        if(sortState.key===key){
          span.textContent = sortState.dir===1 ? "â–²" : "â–¼";
        } else {
          span.textContent = "";
        }
      });
    }

    // ---- Days
    function daysUntil(dstr){
      if (!dstr) return null;
      const d = new Date(dstr+"T00:00:00");
      const t = new Date(); t.setHours(0,0,0,0);
      return Math.round((d-t)/86400000);
    }
    function workdaysUntil(dstr){
      if (!dstr) return null;
      let d=new Date(); d.setHours(0,0,0,0);
      const end = new Date(dstr+"T00:00:00");
      let count=0;
      while (d<=end){
        const ymd=d.toISOString().slice(0,10);
        const isWeekend=(d.getDay()===0||d.getDay()===6);
        const isHoliday=holidays.has(ymd);
        if (!isWeekend && !isHoliday) count++;
        d.setDate(d.getDate()+1);
      }
      return count;
    }

    // ---- Warnings
    function renderWarnings(){
      const warnEl=document.getElementById("warnings");
      const list = jobs.map(j=>({id:j.id, jobNo:j.jobNo, dd:daysUntil(j.dueDate), due:j.dueDate}))
                       .filter(x=>x.due)
                       .filter(x=>x.dd<=DUE_SOON_DAYS);
      if (!list.length){ warnEl.classList.add("hidden"); warnEl.innerHTML=""; return; }
      const overdue = list.filter(x=>x.dd<0);
      const soon = list.filter(x=>x.dd>=0);
      warnEl.classList.remove("hidden");
      warnEl.innerHTML = `<div><strong>ã‚¢ãƒ©ãƒ¼ãƒˆ</strong>ï¼šæœŸé™åˆ‡ã‚Œ ${overdue.length} ä»¶ / ã¾ã‚‚ãªãæœŸé™ ${soon.length} ä»¶ï¼ˆé–¾å€¤ï¼š${DUE_SOON_DAYS}æ—¥ï¼‰</div>
        <div class="muted" style="margin-top:6px;">${list.map(x=>`<span class="pill" style="margin:2px;">${x.jobNo}ï¼ˆæ®‹${x.dd}æ—¥ï¼‰</span>`).join("")}</div>`;
    }

    // ---- Table
    function renderTable(){
      const tbody=document.querySelector("#jobsTable tbody");
      let filtered = applyFilters(jobs);
      filtered = sortJobs(filtered);
      const sorted = filtered;
      tbody.innerHTML = sorted.map(r=>{
        const dd=daysUntil(r.dueDate), wd=workdaysUntil(r.dueDate);
        const cls = dd==null ? "" : (dd<0?"due-bad":(dd<=DUE_SOON_DAYS?"due-soon":""));
        return `<tr data-id="${r.id}" class="${cls}">
          <td class="nowrap">
            ${r.jobNo||""}
            <button class="ghost btnToDwg" data-job="${r.jobNo||""}" title="å›³é¢">ğŸ“„</button>
          </td>
          <td>${r.customer||""}</td>
          <td>${r.projectName||""}</td>
          <td>${r.itemName||""}</td>
          <td class="right">${r.qty||""}</td>
          <td>${r.factory||""}</td>
          <td>${fmtDate(r.dueDate)||""}</td>
          <td><span class="pill status-${r.status}">${r.status||""}</span></td>
          <td>${r.inspection||""}</td>
          <td>${fmtDate(r.shipDate)||""}</td>
          <td>${fmtDate(r.arriveDate)||""}</td>
          <td>${r.shipMethod||""}</td>
          <td>${r.deliveryTo||""}</td>
          <td>${r.invoiceOk||""}</td>
          <td>${r.invoiceNo||""}</td>
          <td>${r.notes||""}</td>
          <td class="right">${dd==null?"":dd}</td>
          <td class="right">${wd==null?"":wd}</td>
          <td>${r.autoFlow==="on"?"ON":"OFF"}</td>
        </tr>`;
      }).join("");
      tbody.querySelectorAll("tr").forEach(tr=> tr.addEventListener("click", ()=> openEdit(tr.getAttribute("data-id"))));
      tbody.querySelectorAll(".btnToDwg").forEach(b=> b.addEventListener("click",(e)=>{
        e.stopPropagation();
        const job = e.currentTarget.getAttribute("data-job")||"";
        switchTab("drawings");
        const q = document.getElementById("qDwgJob"); if(q){ q.value = job; }
        renderDwgs();
      }));
    }

    // ---- Kanban/Weekly
    function renderKanban(){
      const wrap=document.getElementById("kanban"); wrap.innerHTML="";
      masters.statuses.filter(s=>s.active).map(s=>s.name).forEach(st=>{
        const col=document.createElement("div"); col.className="col"; col.dataset.status=st;
        col.innerHTML=`<h3>${st}</h3><div class="dropzone"></div>`;
        const zone=col.querySelector(".dropzone");
        applyFilters(jobs).filter(j=>j.status===st).forEach(r=>{
          const dd=daysUntil(r.dueDate), wd=workdaysUntil(r.dueDate);
          const ddTxt=dd==null?"æœªå®š":(dd+"æ—¥"); const wdTxt=wd==null?"-":(wd+"ç¨¼åƒæ—¥");
          const el=document.createElement("div"); el.className="card-k"; el.draggable=true; el.dataset.id=r.id;
          el.innerHTML=`<div class="title">${r.jobNo} ${r.itemName} <span class="pill status-${r.status}" style="float:right">${r.qty||""}å°</span></div>
            <div class="muted">${r.customer}ï¼${r.factory}</div>
            <div class="muted">ç´æœŸ: ${fmtDate(r.dueDate)||"æœªå®š"}ï¼ˆæ®‹${ddTxt}ï¼${wdTxt}ï¼‰</div>`;
          el.addEventListener("dragstart", e=> e.dataTransfer.setData("text/plain", r.id));
          el.addEventListener("dblclick", ()=> openEdit(r.id));
          zone.appendChild(el);
        });
        ["dragover","dragleave","drop"].forEach(ev=>{
          zone.addEventListener(ev, e=>{
            e.preventDefault();
            if (ev==="dragover") col.classList.add("over");
            if (ev==="dragleave") col.classList.remove("over");
            if (ev==="drop"){ col.classList.remove("over"); moveStatus(e.dataTransfer.getData("text/plain"), st); }
          });
        });
        wrap.appendChild(col);
      });
    }
    function renderWeekly(){
      const div=document.getElementById("weekly");
      const list=applyFilters(jobs).filter(j=>j.dueDate).sort((a,b)=> a.dueDate.localeCompare(b.dueDate));
      const groups={};
      list.forEach(j=>{ const k=weekKey(j.dueDate); (groups[k] ||= []).push(j); });
      div.innerHTML = Object.keys(groups).sort().map(key=>{
        const arr=groups[key]; const span=spanDays(arr); const label=weekLabel(key);
        const totalQty=arr.reduce((s,x)=> s+(x.qty||0),0);
        const byFactory=groupCount(arr,a=>a.factory);
        return `<div class="week"><div>
          <strong>${label}</strong>
          <div class="muted">${arr.length}ä»¶ï¼${totalQty}å°</div>
          <div class="muted">${Object.keys(byFactory).map(k=>`${k}:${byFactory[k]}ä»¶`).join("ã€€")}</div>
          </div><div><div class="bar" style="width:${Math.min(100,10+span*8)}%"></div>
          <div>${arr.map(j=>`<span class="pill status-${j.status}" style="margin:4px 6px 0 0; display:inline-block;">${j.jobNo}:${j.itemName}</span>`).join("")}</div>
        </div></div>`;
      }).join("") || '<div class="muted">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
    }
    function groupCount(arr, fn){ const m={}; arr.forEach(a=>{ const k=fn(a)||"æœªè¨­å®š"; m[k]=(m[k]||0)+1; }); return m; }
    function spanDays(arr){
      const xs=arr.map(a=>Date.parse(a.dueDate)).filter(Boolean); if (xs.length<2) return 1;
      const min=Math.min(...xs), max=Math.max(...xs); return Math.max(1, Math.round((max-min)/86400000)+1);
    }
    function weekKey(dstr){ const d=new Date(dstr+"T00:00:00"); const tmp=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); tmp.setUTCDate(tmp.getUTCDate()+4-(tmp.getUTCDay()||7)); const ys=new Date(Date.UTC(tmp.getUTCFullYear(),0,1)); const wn=Math.ceil((((tmp-ys)/86400000)+1)/7); return tmp.getUTCFullYear()+"-W"+String(wn).padStart(2,"0"); }
    function weekLabel(key){ const [y,w]=key.split("-W"); return `${y}å¹´ ç¬¬${parseInt(w)}é€±`; }

    // ---- Move status with auto-flow
    function moveStatus(id, newStatus){
      const idx=jobs.findIndex(j=>j.id===id); if (idx<0) return;
      const rec=jobs[idx]; const old=rec.status;
      rec.status=newStatus;
      if (newStatus==="å‡ºè·" && !rec.shipDate) rec.shipDate=todayStr();
      if (newStatus==="ç€"){ if (!rec.arriveDate) rec.arriveDate=todayStr(); if (INVOICE_AUTO_ON_ARRIVE && !rec.invoiceOk) rec.invoiceOk="å¯"; }
      if (newStatus==="è«‹æ±‚"){ rec.invoiceOk="å¯"; ensureInvoiceNo(rec); }
      log(`å·¥ç¨‹ç§»å‹•: ${rec.jobNo} ${old}â†’${newStatus}`);
      saveJobs(); renderAll();
    }

    // ---- Edit dialog
    function openEdit(id){
      const dlg=document.getElementById("editDialog");
      const form=document.getElementById("editForm");
      const rec = id ? jobs.find(j=>j.id===id) : { id:uid(), status:"å›³é¢", qty:1, inspection:"æœª", autoFlow: settings.autoFlowDefault };

      form.reset(); form.dataset.id=rec.id;

      setOptions(form.elements.customer, masterNames(masters.customers));
      setOptions(form.elements.factory, masterNames(masters.factories));
      setOptions(form.elements.status, masterNames(masters.statuses));
      setOptions(form.elements.inspection, masters.inspections.filter(x=>x.active).map(x=>x.name));
      setOptions(form.elements.shipMethod, masterNames(masters.shipmentMethods));

      form.elements.jobNo.value = rec.jobNo||"";
      form.elements.customer.value = rec.customer||"";
      form.elements.projectName.value = rec.projectName||"";
      form.elements.itemName.value = rec.itemName||"";
      form.elements.qty.value = rec.qty||1;
      form.elements.factory.value = rec.factory||"";
      form.elements.dueDate.value = rec.dueDate||"";
      form.elements.status.value = rec.status||"å›³é¢";
      form.elements.inspection.value = rec.inspection||"æœª";
      form.elements.shipDate.value = rec.shipDate||"";
      form.elements.arriveDate.value = rec.arriveDate||"";
      form.elements.shipMethod.value = rec.shipMethod||"";
      form.elements.deliveryTo.value = rec.deliveryTo||"";
      form.elements.invoiceOk.value = rec.invoiceOk||"";
      form.elements.invoiceNo.value = rec.invoiceNo||"";
      form.elements.autoFlow.value = rec.autoFlow||"on";
      form.elements.notes.value = rec.notes||"";

      document.getElementById("dlgTitle").textContent = id ? ("ç·¨é›†ï¼š" + rec.jobNo) : "æ–°è¦ç™»éŒ²";
      dlg.showModal();
    }

    document.getElementById("editForm").addEventListener("submit", (e)=>{
      e.preventDefault();
      const f=e.currentTarget; const id=f.dataset.id || uid();
      const obj={
        id,
        jobNo: f.elements.jobNo.value.trim(),
        customer: f.elements.customer.value,
        customerCode: codeByName(masters.customers, f.elements.customer.value),
        projectName: f.elements.projectName.value.trim(),
        itemName: f.elements.itemName.value.trim(),
        qty: parseInt(f.elements.qty.value||"0",10)||0,
        factory: f.elements.factory.value,
        dueDate: f.elements.dueDate.value,
        status: f.elements.status.value,
        inspection: f.elements.inspection.value,
        shipDate: f.elements.shipDate.value,
        arriveDate: f.elements.arriveDate.value,
        shipMethod: f.elements.shipMethod.value,
        deliveryTo: f.elements.deliveryTo.value.trim(),
        invoiceOk: f.elements.invoiceOk.value,
        invoiceNo: f.elements.invoiceNo.value.trim(),
        autoFlow: f.elements.autoFlow.value,
        notes: f.elements.notes.value.trim()
      };
      if (!obj.jobNo){ alert("å·¥ç•ªã¯å¿…é ˆã§ã™"); return; }
      applyAutoFlow(obj);
      const idx=jobs.findIndex(j=>j.id===id);
      if (idx>=0){ jobs[idx]=obj; log(`æ›´æ–°: ${obj.jobNo}`); } else { jobs.push(obj); log(`æ–°è¦: ${obj.jobNo}`); }
      saveJobs(); renderAll(); document.getElementById("editDialog").close();
    });

    document.getElementById("btnDlgCancel").addEventListener("click", ()=> document.getElementById("editDialog").close());
    document.getElementById("btnAdd").addEventListener("click", ()=> openEdit(null));
    document.getElementById("btnSave").addEventListener("click", ()=> { saveJobs(); toast("ä¿å­˜ã—ã¾ã—ãŸï¼ˆç«¯æœ«ãƒ­ãƒ¼ã‚«ãƒ«ï¼‰"); });

    // ---- Auto flow implementation
    function applyAutoFlow(rec){
      if (rec.autoFlow!=="on") return;
      if (rec.inspection==="ä¿ç•™"){ rec.status="æ¤œæŸ»"; return; }
      if (rec.arriveDate){ rec.status="ç€"; if (INVOICE_AUTO_ON_ARRIVE && !rec.invoiceOk) rec.invoiceOk="å¯"; }
      else if (rec.shipDate){ rec.status="å‡ºè·"; }
      else if (rec.inspection==="OK"){ rec.status="å‡ºè·"; }
      const n = (rec.notes||"");
      if (!rec.shipDate && !rec.arriveDate){
        if (/\[è£½ä½œå®Œ\]/.test(n)) rec.status="æ¤œæŸ»";
        else if (/\[åˆ‡å‡ºå®Œ\]/.test(n)) rec.status="è£½ä½œ";
      }
    }

    // ---- Numbering
    function ensureInvoiceNo(rec){
      if (rec.invoiceNo && rec.invoiceNo.trim()!=="") return;
      if (settings.invoiceMode==="manual") return;
      const ymd=todayStr(); const yy=ymd.slice(2,4), mm=ymd.slice(5,7);
      const prefix = (settings.invoiceMode==="by-customer-seq")
        ? `${(rec.customerCode||"OT")}-${yy}${mm}-`
        : `${yy}${mm}-`;
      const next = nextSeq(prefix);
      rec.invoiceNo = prefix + next;
    }
    function nextSeq(prefix){
      const start = settings.invoiceSeqStart || "0001";
      const used = jobs.map(j=> j.invoiceNo||"").filter(s=> s.startsWith(prefix)).map(s=> parseInt(s.slice(prefix.length),10)).filter(n=>!isNaN(n));
      const maxv = used.length ? Math.max(...used) : (parseInt(start,10)-1||0);
      const n = maxv + 1;
      return String(n).padStart(4,"0");
    }

    // ---- CSV/JSON
    function downloadBlob(blob, filename){
      const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=filename; a.click();
      setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
    }
    function exportCsv(){
      const cols = ["å·¥ç•ª","å®¢å…ˆ","å·¥äº‹å","å“å","å°æ•°","è£½ä½œå·¥å ´","ç´æœŸ","çŠ¶æ³","æ¤œæŸ»","å‡ºè·æ—¥","ç€æ—¥","å‡ºè·æ‰‹æ®µ","ç´å“å…ˆ","è«‹æ±‚å¯","ç´å“æ›¸ç•ªå·","å‚™è€ƒ","è‡ªå‹•é·ç§»"];
      const map = r => [r.jobNo,r.customer,r.projectName,r.itemName,r.qty,r.factory,r.dueDate,r.status,r.inspection,r.shipDate,r.arriveDate,r.shipMethod,r.deliveryTo,r.invoiceOk,r.invoiceNo,r.notes,r.autoFlow];
      const rows=[cols].concat(applyFilters(jobs).map(map));
      const csv=rows.map(row=> row.map(x=>{
        const s=(x==null?"":String(x)); return /[",\n]/.test(s)?('"'+s.replace(/"/g,'""')+'"'):s;
      }).join(",")).join("\n");
      downloadBlob(new Blob([csv],{type:"text/csv"}), "jobs.csv");
    }
    function exportJson(){ downloadBlob(new Blob([JSON.stringify(jobs,null,2)],{type:"application/json"}),"jobs.json"); }
    function exportInvoiceCsv(){
      const targets=jobs.filter(j=> j.status==="è«‹æ±‚" || (j.invoiceOk==="å¯" && j.arriveDate));
      const cols=["å·¥ç•ª","å“å","å°æ•°","ç€æ—¥","ç´å“å…ˆ","ç´å“æ›¸ç•ªå·","å®¢å…ˆ","å·¥äº‹å","æ¤œåæ—¥","ç¨åŒºåˆ†","å‚™è€ƒ"];
      const map=r=> [r.jobNo,r.itemName,r.qty,r.arriveDate||"",r.deliveryTo||"",r.invoiceNo||"",r.customer||"",r.projectName||"","", "èª²ç¨10%",""];
      const rows=[cols].concat(targets.map(map));
      const csv=rows.map(row=> row.map(x=>{ const s=(x==null?"":String(x)); return /[",\n]/.test(s)?('"'+s.replace(/"/g,'""')+'"'):s; }).join(",")).join("\n");
      downloadBlob(new Blob([csv],{type:"text/csv"}),"è«‹æ±‚è‰æ¡ˆ.csv");
    }

    // ---- Holiday CSV
    function normalizeDateToken(s){
      const m=(s||"").match(/(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})/); if(!m) return null;
      const y=m[1], mo=String(m[2]).padStart(2,'0'), d=String(m[3]).padStart(2,'0'); return `${y}-${mo}-${d}`;
    }
    function onHolidayCsv(e){
      const f=e.target.files[0]; if(!f) return;
      const fr=new FileReader();
      fr.onload=()=>{
        try{
          const lines=fr.result.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); let added=0;
          lines.forEach(line=>{
            const parts=line.split(/[,\t]/); let ymd=null;
            for(const p of parts){ const t=normalizeDateToken(p); if(t){ ymd=t; break; } }
            if(!ymd && parts.length===1 && /^\d{4}-\d{2}-\d{2}$/.test(parts[0])) ymd=parts[0];
            if(ymd){ holidays.add(ymd); added++; }
          });
          saveHolidays(); alert(`ä¼‘æ—¥CSVã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸï¼ˆ${holidays.size}æ—¥, è¿½åŠ  ${added}ï¼‰`); renderAll();
        }catch(err){ alert("ä¼‘æ—¥CSVå–è¾¼ã‚¨ãƒ©ãƒ¼: "+err.message); }
      };
      fr.readAsText(f); e.target.value="";
    }

    // ---- Masters UI
    function renderMasters(){
      const mount = (id, listName)=>{
        const el=document.getElementById(id); const list=masters[listName];
        el.innerHTML = list.map((row,i)=>`
          <div class="row" data-idx="${i}">
            <input type="checkbox" ${row.active?"checked":""} class="m-active" title="æœ‰åŠ¹/ç„¡åŠ¹" />
            <input type="text" value="${row.code}" class="m-code" style="width:64px;">
            <input type="text" value="${row.name}" class="m-name" style="flex:1;">
            <button class="ghost m-up">â†‘</button><button class="ghost m-down">â†“</button>
            <button class="ghost m-del">å‰Šé™¤</button>
          </div>`).join("") + `<div style="margin-top:6px;"><button class="ghost m-add">ï¼‹ è¿½åŠ </button></div>`;
        el.querySelectorAll(".m-active").forEach((ck,idx)=> ck.addEventListener("change", ()=>{ list[idx].active=ck.checked; saveMasters(); renderAll(); }));
        el.querySelectorAll(".m-code").forEach((ip,idx)=> ip.addEventListener("change", ()=>{ list[idx].code=ip.value.trim(); saveMasters(); }));
        el.querySelectorAll(".m-name").forEach((ip,idx)=> ip.addEventListener("change", ()=>{ list[idx].name=ip.value.trim(); saveMasters(); renderAll(); }));
        el.querySelectorAll(".m-up").forEach((bt,idx)=> bt.addEventListener("click", ()=>{ if(idx>0){ const t=list[idx]; list[idx]=list[idx-1]; list[idx-1]=t; saveMasters(); renderMasters(); renderAll(); } }));
        el.querySelectorAll(".m-down").forEach((bt,idx)=> bt.addEventListener("click", ()=>{ if(idx<list.length-1){ const t=list[idx]; list[idx]=list[idx+1]; list[idx+1]=t; saveMasters(); renderMasters(); renderAll(); } }));
        el.querySelectorAll(".m-del").forEach((bt,idx)=> bt.addEventListener("click", ()=>{ list.splice(idx,1); saveMasters(); renderMasters(); renderAll(); }));
        el.querySelector(".m-add").addEventListener("click", ()=>{ list.push({code:"",name:"",active:true}); saveMasters(); renderMasters(); });
      };
      mount("master-customers","customers");
      mount("master-factories","factories");
      mount("master-ship","shipmentMethods");
      mount("master-statuses","statuses");
    }

    function exportMastersCsv(){
      const rows=[["åŒºåˆ†","ã‚³ãƒ¼ãƒ‰","åç§°","æœ‰åŠ¹"]];
      const push=(k)=> masters[k].forEach(x=> rows.push([k, x.code, x.name, x.active?"1":"0"]));
      ["customers","factories","shipmentMethods","statuses","inspections"].forEach(push);
      const csv=rows.map(r=> r.map(x=> { const s=(x==null?"":String(x)); return /[",\n]/.test(s)?('"'+s.replace(/"/g,'""')+'"'):s; }).join(",")).join("\n");
      downloadBlob(new Blob([csv],{type:"text/csv"}), "masters.csv");
    }

    function downloadCsvTemplate(){
      const cols = ["å·¥ç•ª","å®¢å…ˆ","å·¥äº‹å","å“å","å°æ•°","è£½ä½œå·¥å ´","ç´æœŸ","çŠ¶æ³","æ¤œæŸ»","å‡ºè·æ—¥","ç€æ—¥","å‡ºè·æ‰‹æ®µ","ç´å“å…ˆ","è«‹æ±‚å¯","ç´å“æ›¸ç•ªå·","å‚™è€ƒ"];
      const sample = ["7E1-1","å¤§å”","Då€‰åº«","æ¢å‹æ ","3","æœ¬ç¤¾å·¥å ´","2025-08-05","å›³é¢","æœª","","","è‡ªç¤¾2t","Då€‰åº«","","",""];
      const csv = [cols.join(","), sample.join(",")].join("\n");
      downloadBlob(new Blob([csv], { type: "text/csv" }), "æ¡ˆä»¶å–è¾¼ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ_v33.csv");
    }

    function onMastersCsv(e){
      const f=e.target.files[0]; if(!f) return; const fr=new FileReader();
      fr.onload=()=>{
        try{
          const lines=fr.result.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
          const dest={"customers":[],"factories":[],"shipmentMethods":[],"statuses":[],"inspections":[]};
          lines.slice(1).forEach(line=>{
            const row=line.split(",");
            const key=row[0]; const code=row[1]; const name=row[2]; const active=row[3]==="1";
            if(dest[key]) dest[key].push({code,name,active});
          });
          Object.assign(masters, dest); saveMasters(); renderMasters(); renderAll(); toast("ãƒã‚¹ã‚¿ãƒ¼ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸ");
        }catch(err){ alert("ãƒã‚¹ã‚¿ãƒ¼å–è¾¼ã‚¨ãƒ©ãƒ¼: "+err.message); }
      };
      fr.readAsText(f); e.target.value="";
    }

    // ---- Inspection templates CSV import/export
    function onInspectionTemplatesCsv(e){
      const f=e.target.files[0]; if(!f) return; const fr=new FileReader();
      fr.onload=()=>{
        try{
          const lines=fr.result.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
          lines.forEach(line=>{
            // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: ãƒ†ãƒ³ãƒ—ãƒ¬å,é …ç›®1;é …ç›®2;é …ç›®3
            const parts=line.split(",");
            if(parts.length<2) return;
            const name=parts[0];
            const criteria=parts[1].split(";").map(s=>s.trim()).filter(Boolean);
            inspectionTemplates.push({id: uid(), name, criteria});
          });
          saveInspectionTemplates();
          renderInspectionTemplates();
          toast("æ¤œæŸ»ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå–ã‚Šè¾¼ã¿ã¾ã—ãŸ");
        }catch(err){ alert("æ¤œæŸ»ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå–è¾¼ã‚¨ãƒ©ãƒ¼: "+err.message); }
      };
      fr.readAsText(f); e.target.value="";
    }
    function exportInspectionTemplatesCsv(){
      if(!inspectionTemplates.length){ alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“"); return; }
      const rows=inspectionTemplates.map(t=> [t.name, (t.criteria||[]).join(";")]);
      const csv = rows.map(r=> r.map(x=> {
        const s=(x==null?"":String(x));
        return /[",\n]/.test(s)?('"'+s.replace(/"/g,'""')+'"'):s;
      }).join(",")).join("\n");
      downloadBlob(new Blob([csv],{type:"text/csv"}), "inspection_templates.csv");
    }
    function renderInspectionTemplates(){
      const div=document.getElementById("inspection-templates-list");
      if(!div) return;
      if(!inspectionTemplates.length){
        div.innerHTML = '<div class="muted">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãªã—</div>';
        return;
      }
      div.innerHTML = inspectionTemplates.map(t=>`
        <div style="border:1px solid var(--line); padding:8px; border-radius:6px; margin-bottom:6px; display:flex; justify-content:space-between; align-items:center;">
          <div>
            <strong>${t.name}</strong><br>
            <span class="subtle">é …ç›®: ${ (t.criteria||[]).join(" / ") }</span>
          </div>
          <div>
            <button class="ghost btnDelInspection" data-id="${t.id}">å‰Šé™¤</button>
          </div>
        </div>
      `).join("");
      div.querySelectorAll(".btnDelInspection").forEach(b=>{
        b.addEventListener("click",(e)=>{
          const id=e.currentTarget.dataset.id;
          const idx=inspectionTemplates.findIndex(x=>x.id===id);
          if(idx>=0){
            inspectionTemplates.splice(idx,1);
            saveInspectionTemplates();
            renderInspectionTemplates();
          }
        });
      });
    }

    // ---- Jobs CSV import
    function onJobsCsv(e){
      const f=e.target.files[0]; if(!f) return; const fr=new FileReader();
      fr.onload=()=>{
        try{
          const rows=parseCsv(fr.result); if(!rows.length) throw new Error("CSVã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
          const header=rows[0]; const idx=(name)=> header.indexOf(name);
          const required=["å·¥ç•ª","å“å"]; for(const r of required){ if(idx(r)===-1) throw new Error("ãƒ˜ãƒƒãƒ€ãƒ¼ã«ã€Œ"+r+"ã€ãŒå¿…è¦ã§ã™"); }
          for(let i=1;i<rows.length;i++){
            const r=rows[i]; if(!r || r.length===0) continue;
            const obj={
              id: uid(),
              jobNo: r[idx("å·¥ç•ª")]||"",
              customer: (idx("å®¢å…ˆ")>=0?r[idx("å®¢å…ˆ")]:"")||"",
              customerCode: codeByName(masters.customers, (idx("å®¢å…ˆ")>=0?r[idx("å®¢å…ˆ")]:"")||""),
              projectName: (idx("å·¥äº‹å")>=0?r[idx("å·¥äº‹å")]:"")||"",
              itemName: r[idx("å“å")]||"",
              qty: parseInt((idx("å°æ•°")>=0?r[idx("å°æ•°")]:"0"),10)||0,
              factory: (idx("è£½ä½œå·¥å ´")>=0?r[idx("è£½ä½œå·¥å ´")]:"")||"",
              dueDate: normalizeDateToken((idx("ç´æœŸ")>=0?r[idx("ç´æœŸ")]:""))||"",
              status: (idx("çŠ¶æ³")>=0?r[idx("çŠ¶æ³")]:"")||"å›³é¢",
              inspection: (idx("æ¤œæŸ»")>=0?r[idx("æ¤œæŸ»")]:"")||"æœª",
              shipDate: normalizeDateToken((idx("å‡ºè·æ—¥")>=0?r[idx("å‡ºè·æ—¥")]:""))||"",
              arriveDate: normalizeDateToken((idx("ç€æ—¥")>=0?r[idx("ç€æ—¥")]:""))||"",
              shipMethod: (idx("å‡ºè·æ‰‹æ®µ")>=0?r[idx("å‡ºè·æ‰‹æ®µ")]:"")||"",
              deliveryTo: (idx("ç´å“å…ˆ")>=0?r[idx("ç´å“å…ˆ")]:"")||"",
              invoiceOk: (idx("è«‹æ±‚å¯")>=0?r[idx("è«‹æ±‚å¯")]:"")||"",
              invoiceNo: (idx("ç´å“æ›¸ç•ªå·")>=0?r[idx("ç´å“æ›¸ç•ªå·")]:"")||"",
              notes: (idx("å‚™è€ƒ")>=0?r[idx("å‚™è€ƒ")]:"")||"",
              autoFlow: "on"
            };
            if (obj.arriveDate && !obj.invoiceOk) obj.invoiceOk="å¯";
            jobs.push(obj);
          }
          saveJobs(); renderAll(); alert((rows.length-1)+"ä»¶ å–ã‚Šè¾¼ã¿ã¾ã—ãŸ");
        }catch(err){ alert("æ¡ˆä»¶CSVå–è¾¼ã‚¨ãƒ©ãƒ¼: "+err.message); }
      };
      fr.readAsText(f); e.target.value="";
    }
    function parseCsv(text){
      const lines=text.split(/\r?\n/); let rows=[]; let cur=[], inq=false, field="";
      function pushField(){ cur.push(field); field=""; }
      function pushRow(){ rows.push(cur); cur=[]; }
      for(let i=0;i<lines.length;i++){
        const line=lines[i];
        for(let j=0;j<line.length;j++){
          const c=line[j];
          if(inq){
            if(c=='"' && j+1<line.length && line[j+1]=='"'){ field+='"'; j++; }
            else if(c=='"'){ inq=false; }
            else field+=c;
          } else {
            if(c=='"'){ inq=true; }
            else if(c==','){ pushField(); }
            else field+=c;
          }
        }
        pushField(); pushRow();
      }
      rows=rows.filter(r=> r.some(x=> (x||"").trim()!=="")); return rows;
    }

    // ---- Laser ZIP mock
    document.getElementById("laserZip").addEventListener("change", (e)=>{
      const f=e.target.files[0]; if(!f) return;
      let progress=0;
      const timer=setInterval(()=>{
        progress+=10;
        toast(`ãƒ¬ãƒ¼ã‚¶ãƒ¼Zipè§£æä¸­â€¦ ${progress}%`);
        if(progress>=100){ clearInterval(timer); toast("ãƒ¬ãƒ¼ã‚¶ãƒ¼å–è¾¼å®Œäº†ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰"); }
      }, 200);
      e.target.value="";
    });

    // ---- Masters helper
    function codeByName(list, name){ const x=list.find(a=>a.name===name); return x?x.code:"OT"; }

    // ---- Logs
    function log(msg){ logs.push({ts:new Date().toISOString(), role: settings.role, msg}); saveLogs(); renderLogs(); }
    function renderLogs(){
      const div=document.getElementById("logs");
      div.innerHTML = logs.slice(-200).map(l=> `<div class="subtle">${l.ts} [${l.role}] ${l.msg}</div>`).join("") || '<div class="muted">ãƒ­ã‚°ãªã—</div>';
    }

    // ---- å›³é¢ï¼ˆä¸€è¦§ & æ“ä½œï¼‰ filters
    function fillDwgJobSelect(){
      const sel = document.getElementById("dwgJob");
      if(!sel) return;
      const opts = ['<option value="">å·¥ç•ªé¸æŠ</option>'].concat(
        [...new Set(jobs.map(j=>j.jobNo))].map(jno=> `<option value="${jno}">${jno}</option>`)
      );
      sel.innerHTML = opts.join("");
    }

    function renderDwgs(){
      const qJob =(document.getElementById("qDwgJob") ?.value||"").toLowerCase();
      const qCus =(document.getElementById("qDwgCust")?.value||"").toLowerCase();
      const qProject =(document.getElementById("qDwgProject")?.value||"").toLowerCase();
      const qDelivery =(document.getElementById("qDwgDeliveryTo")?.value||"").toLowerCase();
      const qItem=(document.getElementById("qDwgItem")?.value||"").toLowerCase();
      const qNumber=(document.getElementById("qDwgNumber")?.value||"").toLowerCase();
      const qApprove=(document.getElementById("qDwgApprove")?.value||"").toLowerCase();
      const qCheck=(document.getElementById("qDwgCheck")?.value||"").toLowerCase();
      const qDesign=(document.getElementById("qDwgDesign")?.value||"").toLowerCase();
      const qAuthor=(document.getElementById("qDwgAuthor")?.value||"").toLowerCase();
      const qFile=(document.getElementById("qDwgFile")?.value||"").toLowerCase();

      const tb = document.querySelector("#dwgTable tbody");
      if(!tb) return;

      const list = dwgs.filter(x=>
        (!qJob  || (x.jobNo    ||"").toLowerCase().includes(qJob )) &&
        (!qCus  || (x.customer ||"").toLowerCase().includes(qCus )) &&
        (!qProject || (x.projectName||"").toLowerCase().includes(qProject)) &&
        (!qDelivery || (x.deliveryTo||"").toLowerCase().includes(qDelivery)) &&
        (!qItem || (x.itemName ||"").toLowerCase().includes(qItem)) &&
        (!qNumber || (x.drawingNumber ||"").toLowerCase().includes(qNumber)) &&
        (!qApprove || (x.approval||"").toLowerCase().includes(qApprove)) &&
        (!qCheck || (x.check||"").toLowerCase().includes(qCheck)) &&
        (!qDesign || (x.design||"").toLowerCase().includes(qDesign)) &&
        (!qAuthor || (x.author||"").toLowerCase().includes(qAuthor)) &&
        (!qFile || (x.fileName ||"").toLowerCase().includes(qFile))
      );

      tb.innerHTML = list.map(x=>`
        <tr>
          <td>${thumbHtml(x)}</td>
          <td>${x.deliveryTo||""}</td>
          <td>${x.projectName||""}</td>
          <td>${x.jobNo||""}</td>
          <td>${x.drawingNumber||""}</td>
          <td>${fmtDate(x.drawingDate)||""}</td>
          <td>${x.approval||""}</td>
          <td>${x.check||""}</td>
          <td>${x.design||""}</td>
          <td>${x.author||""}</td>
          <td>${x.fileName||""}</td>
          <td>${fmtDateTime(x.uploadedAt)} / ${x.uploadedBy||""}</td>
          <td>
            <button class="ghost btnDwgView" data-id="${x.id}">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
            <button class="ghost btnDwgDel"  data-id="${x.id}">å‰Šé™¤</button>
          </td>
        </tr>
      `).join("") || '<tr><td colspan="13" class="muted">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>';

      tb.querySelectorAll(".btnDwgDel").forEach(b=> b.addEventListener("click",(e)=>{
        const id=e.currentTarget.getAttribute("data-id");
        const i=dwgs.findIndex(d=>d.id===id);
        if(i>=0 && confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){ dwgs.splice(i,1); saveDwgs(); renderDwgs(); }
      }));
      tb.querySelectorAll(".btnDwgView").forEach(b=> b.addEventListener("click",(e)=>{
        const id=e.currentTarget.getAttribute("data-id");
        const row=dwgs.find(d=>d.id===id);
        if(!row) return;
        const w = window.open();
        w.document.write(`<html><head><meta charset="UTF-8"><title>${row.fileName}</title></head>
          <body style="margin:0;"><embed src="${row.dataUrl}" type="${row.mime}" width="100%" height="100%"></body></html>`);
        w.document.close();
      }));
    }
    function thumbHtml(x){
      if((x.mime||"").includes("image/")){
        return `<img src="${x.dataUrl}" alt="" style="width:90px;height:70px;object-fit:cover;border:1px solid #cbd5e1;border-radius:6px;">`;
      }
      return `<div style="width:90px;height:70px;border:1px solid #cbd5e1;border-radius:6px;display:flex;align-items:center;justify-content:center;background:#e2e8f0;font-size:12px;">PDF</div>`;
    }
    function fmtDateTime(s){
      try{
        const d=new Date(s); const p=n=>String(n).padStart(2,"0");
        return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;
      }catch{ return s||""; }
    }

    // ---- Tabs
    function switchTab(tab){
      document.querySelectorAll(".tab").forEach(t=> t.classList.toggle("active", t.dataset.tab===tab));
      document.getElementById("view-list").classList.toggle("hidden", tab!=="list");
      document.getElementById("view-kanban").classList.toggle("hidden", tab!=="kanban");
      document.getElementById("view-weekly").classList.toggle("hidden", tab!=="weekly");
      document.getElementById("view-drawings").classList.toggle("hidden", tab!=="drawings");
      document.getElementById("view-masters").classList.toggle("hidden", tab!=="masters");
      document.getElementById("view-logs").classList.toggle("hidden", tab!=="logs");
      document.getElementById("view-docs").classList.toggle("hidden", tab!=="docs");
    }
    document.querySelectorAll(".tab").forEach(t=> t.addEventListener("click", ()=>{ switchTab(t.dataset.tab); renderAll(); }));

    // ---- Master integrity
    function defaultMasters(){
      return {
        customers: [
          {code:"DK", name:"å¤§å”", active:true},
          {code:"DT", name:"DT", active:true},
          {code:"NG", name:"ä¸­å·", active:true},
          {code:"OT", name:"ãã®ä»–", active:true},
        ],
        factories: [
          {code:"H1", name:"æœ¬ç¤¾å·¥å ´", active:true},
          {code:"H2", name:"ç¬¬2å·¥å ´", active:true},
          {code:"PA", name:"å”åŠ›å·¥å ´A", active:true},
        ],
        shipmentMethods: [
          {code:"T2", name:"è‡ªç¤¾2t", active:true},
          {code:"T4", name:"è‡ªç¤¾4t", active:true},
          {code:"10U", name:"10tãƒ¦ãƒ‹ãƒƒã‚¯", active:true},
          {code:"4U", name:"4tãƒ¦ãƒ‹ãƒƒã‚¯", active:true},
          {code:"10", name:"10t", active:true},
          {code:"TR", name:"ãƒˆãƒ¬ãƒ¼ãƒ©ãƒ¼", active:true},
          {code:"YO", name:"åº¸è»Š", active:true},
          {code:"DL", name:"å®…é…", active:true},
          {code:"PU", name:"å¼•å–", active:true},
        ],
        statuses: [
          {code:"D", name:"å›³é¢", active:true},
          {code:"M", name:"è£½ä½œ", active:true},
          {code:"I", name:"æ¤œæŸ»", active:true},
          {code:"S", name:"å‡ºè·", active:true},
          {code:"A", name:"ç€", active:true},
          {code:"B", name:"è«‹æ±‚", active:true},
        ],
        inspections: [
          {code:"N", name:"æœª", active:true},
          {code:"O", name:"OK", active:true},
          {code:"H", name:"ä¿ç•™", active:true},
        ]
      };
    }
    function ensureMastersIntegrity(){
      const d = defaultMasters();
      ["customers","factories","shipmentMethods","statuses","inspections"].forEach(k=>{
        if(!masters[k] || !Array.isArray(masters[k]) || masters[k].length===0){
          masters[k] = d[k];
        }else{
          masters[k].forEach(x=> { if(typeof x.active==="undefined") x.active=true; });
        }
      });
      saveMasters();
    }

    function renderAll(){
      ensureMastersIntegrity();
      renderWarnings();
      renderTable();
      renderKanban();
      renderWeekly();
      renderMasters();
      renderLogs();
      renderInspectionTemplates();
      fillDwgJobSelect();
      if (!document.getElementById("view-drawings").classList.contains("hidden")) renderDwgs();
      updateSortIndicators();
      bindHeaderSorting();
    }

    // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¯ãƒªãƒƒã‚¯ã«ã‚ˆã‚‹ã‚½ãƒ¼ãƒˆãƒã‚¤ãƒ³ãƒ‰ï¼ˆ1å›ã ã‘ï¼‰
    let headerSortBound=false;
    function bindHeaderSorting(){
      if(headerSortBound) return;
      headerSortBound=true;
      document.querySelectorAll("#jobsTable th[data-key]").forEach(th=>{
        th.addEventListener("click", ()=>{
          const key=th.dataset.key;
          if(sortState.key===key){
            sortState.dir *= -1;
          } else {
            sortState.key=key; sortState.dir=1;
          }
          renderAll();
        });
      });
    }

    // ---- init
    initFilters();
    renderAll();
  </script>
</body>
</html>
